# AWS S3 Provider Setup

Ingest documents stored in an Amazon S3 bucket. The provider lists objects under an optional prefix and downloads content for indexing.

## Overview
You supply bucket details and authentication either via IAM role (instance profile) or explicit access keys. Filtering is performed by file extension to reduce scan scope. Pagination via `ListObjectsV2` handles large buckets.

## Configuration
Example snippet:
```yaml
Providers:
  S3:
    Enabled: true
    Name: "S3"
    BucketName: "${S3_BUCKET_NAME}"   # e.g. company-docs-prod
    Prefix: "documents/"               # Optional; omit for full bucket
    Region: "us-east-1"
    UseInstanceProfile: false           # true to use EC2/EKS role
    AccessKeyId: "${AWS_ACCESS_KEY_ID}"       # ignored if UseInstanceProfile true
    SecretAccessKey: "${AWS_SECRET_ACCESS_KEY}" # ignored if UseInstanceProfile true
    SessionToken: null                  # optional STS session token
    FileExtensions:
      - ".docx"
      - ".pdf"
      - ".txt"
```

## Auth Modes
| Mode | When to Use | Requirements |
|------|-------------|--------------|
| Instance Profile / IAM Role | Production on EC2/EKS | Role with `s3:ListBucket`, `s3:GetObject` on target bucket/prefix |
| Access Keys | Local dev or cross-account | Access key & secret with least privilege policy |

### Minimal IAM Policy
Grant only required actions:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:ListBucket"],
      "Resource": "arn:aws:s3:::YOUR_BUCKET"
    },
    {
      "Effect": "Allow",
      "Action": ["s3:GetObject"],
      "Resource": "arn:aws:s3:::YOUR_BUCKET/documents/*"
    }
  ]
}
```
Adjust prefix segment accordingly.

## Prefix Strategy
Use a dedicated prefix (e.g. `documents/`) to avoid scanning unrelated objects. Ensure trailing slash consistency.

## Performance
- Provider paginates automatically; memory footprint limited.
- Narrow prefixes and extensions for speed.
- Consider S3 Inventory reports if bucket is extremely large (> millions objects) â€” future enhancement.

## ETag & Change Detection
S3 object ETags are captured and compared with stored metadata for incremental updates. For multipart uploads the ETag may differ from MD5; still adequate for change detection.

## Troubleshooting
| Issue | Cause | Fix |
|-------|-------|-----|
| `AccessDenied` during list | Missing permission | Add `s3:ListBucket` on bucket ARN. |
| Empty results | Wrong prefix or no matching extensions | Remove prefix or verify object keys. |
| Slow initial scan | Massive bucket without prefix | Introduce prefix segmentation. |
| Throttling errors | High request rate | Add backoff/retry (future); narrow scope. |

## Security Notes
- Prefer IAM roles over long-lived keys.
- Rotate access keys if used.
- Restrict policy to needed actions & prefix.

## Cross-links & Next Steps
Combine with [OneDrive Business](onedrive-business.md) or [Local Filesystem](local.md) for multi-source ingestion. Review [Multi-provider Implementation](../reports/multi-provider-implementation.md) for orchestration details.
